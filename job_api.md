# job_api.py — current behaviour (summary)

This document summarises how `job_api.py` currently works in the repository, how to run it, and how the API chooses output formats.

**Entry points**
- CLI: `python3 job_api.py --format <json|csv|yaml|xml> --days N --min-score M`
- WSGI: `application(environ, start_response)` for Apache/gunicorn (configured by env vars)
- FastAPI: ASGI app `app` (run with `uvicorn job_api:app --reload`)

**Configuration (env / defaults)**
- `JOBSERVE_DBFILE` — default: `~/.jobserve.gdbm`
- `JOBSERVE_DAYS` — default: `7`
- `JOBSERVE_MIN_SCORE` — default: `5`
- `JOBSERVE_REFRESH_TIMEOUT` — default: `10` (seconds)

**Endpoints**
- `/jobs` — single canonical endpoint. The server selects output format via the HTTP `Accept` header (content negotiation). Supported output types:
  - JSON (default): `application/json`
  - CSV: `text/csv`
  - YAML: `application/x-yaml` or `text/yaml` (requires PyYAML)
  - XML: `application/xml` or `text/xml`
- `/health` — simple health check, returns JSON: `{"status":"ok","api":"job_api"}`

Note: the per-format endpoints (`/jobs/json`, `/jobs/csv`, `/jobs/yaml`, `/jobs/xml`) have been removed — use `Accept` negotiation with `/jobs`.

**How content negotiation works**
- `get_content_type(accept_header)` inspects the `Accept` header and returns one of: `text/csv`, `application/yaml`, `application/xml`, or falls back to `application/json`.
- `format_output(jobs, content_type)` uses a mapping dict to select the correct formatter function and MIME string. The mapping approach centralises format handling and uses `.get()` to default to JSON.

**Formatters**
- JSON: generated by `to_json(jobs)` — default response (indentation included)
- CSV: `to_csv(jobs)` returns a CSV string with a header row (fields: `score,reference,job_title,company,age,location,salary,date,job_url`)
- YAML: `to_yaml(jobs)` uses PyYAML; if PyYAML is not installed the code raises a clear error
- XML: `to_xml(jobs)` builds a minimal XML document using ElementTree

**Database access & filtering**
- `load_jobs(db_path, days)` opens the database (default `~/.jobserve.gdbm`) and returns only records with a `date` within the `days` window.
- `extract_job_data()` performs application-specific filtering:
  - skip records with an `unclassified` marker or where `job_type == 'application'`
  - include only records that contain `scored_job`
  - enforce `min_score` threshold
  - produce job objects with fields: `message_id, score, reference, job_title, company, age, location, salary, date, job_url`

**Database locking & error responses**
- If the DB is locked when a request is made, the API returns `503 Service Unavailable` and includes `Refresh` and `Retry-After` headers. The error body is formatted according to the requested media type.

**Robustness & logging**
- Parsing DB records previously used a bare `except Exception: pass` which hid parsing failures. This has been replaced with targeted exception handling (`ValueError`, `TypeError`, `KeyError`) and a stderr warning is printed when a record is skipped. This helps surface malformed records during ingest or API scans.

**Trusted host handling**
- When Starlette is available the app adds `TrustedHostMiddleware` configured with `allowed_hosts=["*"]` to accept requests with arbitrary `Host` headers (helpful when testing via dynamic DNS). This is intentional for external testing but should be tightened for production.

**Running and examples**
- CLI JSON (local file):
```bash
python3 job_api.py --format json > jobs.json
```

- Start FastAPI locally (loopback):
```bash
python3 -m uvicorn job_api:app --host 127.0.0.1 --port 8000 --reload
```

- Query JSON from the running server:
```bash
curl -H "Accept: application/json" "http://127.0.0.1:8000/jobs?days=7&min_score=5" | jq .
```

- Query CSV via Accept header:
```bash
curl -H "Accept: text/csv" "http://127.0.0.1:8000/jobs?days=7&min_score=5" | head -n 20
```

- Query YAML (via local SOCKS5 proxy example):
```bash
curl --socks5-hostname 127.0.0.1:2080 -H "Accept: application/x-yaml, text/yaml;q=0.9" \
  "http://home.critchley.biz:8000/jobs" | sed -n '1,40p'
```

**Notes & recommendations**
- For production exposure, run the ASGI server behind a reverse proxy (nginx) with TLS and host filtering. Don’t leave `TrustedHostMiddleware` set to accept all hosts for long-term production.
- The API intentionally prioritises doing format selection by header rather than by dedicated endpoints to keep the interface simple and standards-compliant.

If you want this placed into `README.md` or expanded into a standalone `docs/job_api.md` with additional examples (e.g., DB-lock simulation, concurrency testing), tell me and I will create/update the chosen file.
